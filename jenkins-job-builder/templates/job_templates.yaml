- parameter:
    name: 'common_parameters'
    parameters:
      - string:
          name: DEPLOYMENT_TIMEOUT
          default: "10000"
      - string:
          name: TESTRAIL_FILE
          default: "/home/jenkins/testrail.sh"
      - string:
          name: REPORT_FILE
          default: 'report.xml'
      - string:
          name: ENV_INJECT_PATH
          default: 'env_inject{name}.properties'
      - string:
          name: ISO_DIR
          default: "/var/www/fuelweb-iso"

- defaults:
    name: 'common_job_settings'
    wrappers:
      - build-name:
          name: ${{BUILD_NUMBER}}.${{FILE,path="build-name-setter.info"}}

    properties:
      - heavy-job:
          weight: '{weight}'
    defaults: global
    node: '{node}'
    description: '{description}'
    disabled: false
    display-name: '{display_name}'
    concurrent: true
    retry-count: 3
    logrotate:
      daysToKeep: 30
      artifactDaysToKeep: -1
      artifactNumToKeep: -1

    triggers:
        - timed: '{start_timer}'

- publisher:
    name: base_publisher
    publishers:
      - postbuildscript:
          script-only-if-succeeded: False

      - archive:
          artifacts: 'report.xml'
          allow-empty: 'true'
          fingerprint: true

      - archive:
          artifacts: '*.log'
          allow-empty: 'true'
          fingerprint: true

      - junit:
          results: report.xml

      - workspace-cleanup:
          fail-build: false


- publisher:
    name: 'common_publisher'
    publishers:
      - email:
          recipients: 'ogubanov@mirantis.com'
      - base_publisher

- publisher:
    name: report-to-testrail
    publishers:
      - postbuildscript:
          builders:
            - shell:
                !include-raw: ../shell_scripts/template_scripts/testrail_reporter.sh
          script-only-if-succeeded: false
          script-only-if-failed: false

- job-template:
    name: '9.x_horizon_integraion_test_{name}'

    defaults: common_job_settings

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: HORIZON_UI_TESTS
            default: "TRUE"

    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw: ../shell_scripts/template_scripts/horizon_selenium_tests.sh

    publishers:
        - report-to-testrail
        - common_publisher
        - archive:
            artifacts: 'mos-horizon/horizon_autotests/tests/test_reports/**'
            allow-empty: 'true'
            fingerprint: true

- job-template:
    name: '9.x_upstream_heat'

    defaults: common_job_settings

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: TESTRAIL_TEMPEST
            default: "FALSE"

    scm:
        - git:
            url: '{git_url}'
            branches:
                - '{git_branch}'

    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape:
                - ../shell_scripts/revert_last_snapshot.sh
                - ../shell_scripts/template_scripts/get_fuel_master_ip.sh
                - ../shell_scripts/template_scripts/get_fuel_key_and_openrc.sh
                - ../shell_scripts/template_scripts/upstream_heat_test_runner.sh
    publishers:
        - report-to-testrail
        - common_publisher


- job-template:
    name: '9.x_upstream_sahara'

    defaults: common_job_settings

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: TESTRAIL_TEMPEST
            default: "FALSE"

    scm:
        - git:
            url: '{git_url}'
            branches:
                - '{git_branch}'

    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape:
                - ../shell_scripts/revert_last_snapshot.sh
                - ../shell_scripts/template_scripts/get_fuel_master_ip.sh
                - ../shell_scripts/template_scripts/get_fuel_key_and_openrc.sh
                - ../shell_scripts/template_scripts/upstream_sahara_test_runner.sh

    publishers:
        - report-to-testrail
        - common_publisher


- job-template:
    name: '9.x_openstack_cli_{name}'

    defaults: common_job_settings

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: TESTRAIL_TEMPEST
            default: "TRUE"

    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape:
                - ../shell_scripts/revert_last_snapshot.sh
                - ../shell_scripts/template_scripts/get_fuel_master_ip.sh
                - ../shell_scripts/template_scripts/get_fuel_key_and_openrc.sh
                - ../shell_scripts/template_scripts/openstack_cli_tests.sh

    publishers:
        - report-to-testrail
        - common_publisher


- job-template:
    # empty value causes disabled_var to be ignored internally
    disabled_var:

    disabled: '{obj:disabled_var}'

    name: '9.x_Tempest_{name}'

    defaults: common_job_settings

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: DISABLE_SSL
            default: "{is_ssl_disabled}"
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: DESTROY_ENV_AFTER_TESTS
            default: "{destroy_env}"
        - string:
            name: NOVA_QUOTAS_ENABLED
            default: "{nova_quotas}"
        - string:
            name: PARSED_PLUGINS_LINK
            default: "http://jenkins-product.srt.mirantis.net:8080/view/plugins/job/build-fuel-plugins/"
        - string:
            name: PLUGINS_DIR
            default: "/var/www/detach-plugins"
        - string:
            name: TESTRAIL_TEMPEST
            default: "TRUE"
        - string:
            name: TEMPEST
            default: "FALSE"

    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/erase_ci_envs.sh
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape: ../shell_scripts/get_plugins.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw: ../shell_scripts/deploy_env_from_template.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape: ../shell_scripts/revert_last_snapshot.sh
        - shell: sleep 300
        - shell:
            !include-raw-escape: ../shell_scripts/template_scripts/get_fuel_master_ip.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape: ../shell_scripts/run_tempest_new.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw: ../shell_scripts/template_scripts/testrail_reporter.sh

    publishers:
        - common_publisher
        - archive:
            artifacts: 'mos-integration-tests/snapshots/*'
            allow-empty: 'true'
            fingerprint: true


- job-template:
    # empty value causes disabled_var to be ignored internally
    disabled_var:

    disabled: '{obj:disabled_var}'

    name: 'Run_Tempest_{name}'

    defaults: common_job_settings

    parameters:
        - common_parameters
        - string:
            name: ENV_NAME
            default: ''
        - node:
            name: nodes_list
            possible: 'ALL'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: NOVA_QUOTAS_ENABLED
            default: "TRUE"
        - string:
            name: TESTRAIL_TEMPEST
            default: "TRUE"
        - string:
            name: TEMPEST
            default: "FALSE"

    builders:
        - shell:
            !include-raw-escape:
                - ../shell_scripts/revert_last_snapshot.sh
        - shell: sleep 300
        - shell:
            !include-raw-escape:
                - ../shell_scripts/template_scripts/get_fuel_master_ip.sh
                - ../shell_scripts/debug_runner.sh

    publishers:
        - common_publisher
        - archive:
            artifacts: 'mos-integration-tests/snapshots/*'
            allow-empty: 'true'
            fingerprint: true


- job-template:
    name: '9.x_wo_deploy_{name}'

    defaults: common_job_settings

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: TESTRAIL_TEMPEST
            default: "FALSE"

    wrappers:
      - ansicolor

    scm:
        - git:
            url: https://github.com/Mirantis/mos-integration-tests.git
            branches:
                - origin/master

    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw:
                - ../shell_scripts/template_scripts/tox_based_test_runner.sh
                - ../shell_scripts/template_scripts/testrail_reporter.sh

    publishers:
        - common_publisher
        - archive:
            artifacts: 'mos-integration-tests/snapshots/*'
            allow-empty: 'true'
            fingerprint: true

- job-template:
    name: '9.x_{name}'

    defaults: common_job_settings
    ldap_config_file: ../plugins_config/ldap_multidomains.yaml

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: NOVA_QUOTAS_ENABLED
            default: "{nova_quotas}"
        - string:
            name: TESTRAIL_TEMPEST
            default: "FALSE"
        - string:
            name: LDAP_CONFIG_FILE
            default: "{obj:ldap_config_file}"

    wrappers:
      - ansicolor
      - inject-passwords:
          global: true
          mask-password-params: true

    scm:
        - git:
            url: https://github.com/Mirantis/mos-integration-tests.git
            branches:
                - origin/master
    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape: ../shell_scripts/get_plugins.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw:
                - ../shell_scripts/template_scripts/erase_ci_envs.sh
                - ../shell_scripts/deploy_env_from_template.sh
                - ../shell_scripts/template_scripts/tox_based_test_runner.sh
                - ../shell_scripts/template_scripts/testrail_reporter.sh

    publishers:
        - common_publisher
        - archive:
            artifacts: 'mos-integration-tests/snapshots/*'
            allow-empty: 'true'
            fingerprint: true

- job-template:
    name: '9.x_{name}_baremetal'

    defaults: common_job_settings

    disabled_var:

    disabled: '{obj:disabled_var}'

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: NOVA_QUOTAS_ENABLED
            default: "{nova_quotas}"
        - string:
            name: TESTRAIL_TEMPEST
            default: "FALSE"
        - string:
            name: FUEL_DEVOPS_VER
            default: "{fuel_devops_ver}"
        - string:
            name: USE_IPMI
            default: "{use_ipmi}"

    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/erase_ci_envs.sh
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw: ../shell_scripts/deploy_env_from_template.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape: ../shell_scripts/template_scripts/get_fuel_master_ip.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw: ../shell_scripts/template_scripts/tox_based_baremetal_test_runner.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw: ../shell_scripts/template_scripts/testrail_reporter.sh

    wrappers:
      - ansicolor
      - inject-passwords:
          global: true
          mask-password-params: true


    publishers:
        - common_publisher
        - archive:
            artifacts: 'mos-integration-tests/snapshots/*'
            allow-empty: 'true'
            fingerprint: true

- job-template:
    name: '9.0_murano_baremetal_{name}'

    defaults: common_job_settings

    parameters:
        - common_parameters
        - string:
            name: ENV_CHANGER
            default: '{env_changer}'
        - string:
            name: CONFIG_PATH
            default: '{config_path}'
        - string:
            name: TEST_GROUP
            default: '{test_group}'
        - string:
            name: SUITE
            default: "{suite}"
        - string:
            name: MILESTONE
            default: "{milestone}"
        - string:
            name: NOVA_QUOTAS_ENABLED
            default: "{nova_quotas}"
        - string:
            name: TESTRAIL_TEMPEST
            default: "FALSE"
        - string:
            name: FUEL_DEVOPS_VER
            default: "{fuel_devops_ver}"
        - string:
            name: USE_IPMI
            default: "{use_ipmi}"
        - string:
            name: APPS_FROM_CATALOG
            default: '{apps_from_catalog}'
        - string:
            name: DOCKER_IMAGE_URL
            default: "{docker_image_url}"
        - string:
            name: K8S_IMAGE_URL
            default: "{k8s_image_url}"
        - string:
            name: K8S_IMAGE_USER
            default: "debian"

    builders:
        - shell:
            !include-raw: ../shell_scripts/template_scripts/erase_ci_envs.sh
        - shell:
            !include-raw: ../shell_scripts/template_scripts/env_variables_export.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape: ../shell_scripts/get_murano_release_plugin.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw: ../shell_scripts/deploy_env_from_template.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw-escape: ../shell_scripts/template_scripts/get_fuel_master_ip.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            # TODO(agromov): temporariry step for 9.0
            # delete it when we will start to use 9.x for murano jobs
            !include-raw-escape: ../shell_scripts/template_scripts/patch_script_for_murano.sh
        - shell:
            !include-raw: ../shell_scripts/template_scripts/tox_based_murano_test_runner.sh
        - inject:
            properties-file: "$ENV_INJECT_PATH"
        - shell:
            !include-raw: ../shell_scripts/template_scripts/testrail_reporter.sh

    wrappers:
      - ansicolor
      - inject:
          properties-content: |
              USE_9_0=TRUE
              TESTRAIL_PLAN_NAME=9.0 Murano
      - inject-passwords:
          global: true
          mask-password-params: true

    publishers:
        - common_publisher
        - archive:
            artifacts: 'mos-integration-tests/snapshots/*'
            allow-empty: 'true'
            fingerprint: true
        - description-setter:
            regexp: '^.*\[TestRun URL\] \s*(.*)'
            description: '<a href="\1">TestRail Report URL</a>'
